var T=Object.defineProperty;var F=(i,s,t)=>s in i?T(i,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[s]=t;var b=(i,s,t)=>F(i,typeof s!="symbol"?s+"":s,t);import{j as e,a1 as R,k as M,N as J,V as O,a2 as A,a3 as B}from"./ui-Dqq999Tl.js";import{r as g}from"./vendor-6qmzlMN_.js";import{D as _,E as j,B as I,C as y,a as v,b as N,c as S,L as m,I as u}from"./index-DOhnETK5.js";var U="basil",z="https://js.stripe.com",V="".concat(z,"/").concat(U,"/stripe.js"),$=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,q=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/;var G=function(s){return $.test(s)||q.test(s)},Y=function(){for(var s=document.querySelectorAll('script[src^="'.concat(z,'"]')),t=0;t<s.length;t++){var a=s[t];if(G(a.src))return a}return null},k=function(s){var t="",a=document.createElement("script");a.src="".concat(V).concat(t);var n=document.head||document.body;if(!n)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return n.appendChild(a),a},p=null,E=null,w=null,X=function(s){return function(t){s(new Error("Failed to load Stripe.js",{cause:t}))}},Z=function(s,t){return function(){window.Stripe?s(window.Stripe):t(new Error("Stripe.js not available"))}},H=function(s){return p!==null?p:(p=new Promise(function(t,a){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe){t(window.Stripe);return}try{var n=Y();if(!(n&&s)){if(!n)n=k(s);else if(n&&w!==null&&E!==null){var o;n.removeEventListener("load",w),n.removeEventListener("error",E),(o=n.parentNode)===null||o===void 0||o.removeChild(n),n=k(s)}}w=Z(t,a),E=X(a),n.addEventListener("load",w),n.addEventListener("error",E)}catch(r){a(r);return}}),p.catch(function(t){return p=null,Promise.reject(t)}))},x,W=function(){return x||(x=H(null).catch(function(s){return x=null,Promise.reject(s)}),x)};Promise.resolve().then(function(){return W()}).catch(function(i){console.warn(i)});class P{static async initialize(){return this.stripe?this.stripe:(console.error("Missing VITE_STRIPE_PUBLISHABLE_KEY"),null)}static async createPaymentIntent(s){try{const t=await fetch("/.netlify/functions/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:Math.round(s.amount*100),currency:"usd",metadata:{studentName:s.studentName,studentEmail:s.studentEmail,studentPhone:s.studentPhone||"",classDetails:JSON.stringify(s.classDetails||{}),packageDetails:JSON.stringify(s.packageDetails||{})}})});if(!t.ok)throw new Error("Failed to create payment intent");const{clientSecret:a,paymentIntentId:n}=await t.json();return n&&this.paymentDataCache.set(n,s),a}catch(t){return console.error("Error creating payment intent:",t),null}}static async processPayment(s,t,a){console.log("ðŸš€ Starting processPayment with clientSecret:",s);try{if(console.log("ðŸ”§ Initializing Stripe..."),!await this.initialize())throw new Error("Stripe failed to load");console.log("âœ… Stripe initialized successfully"),console.log("Simulating successful payment for testing...");const o=s.split("_secret_")[0];console.log("Payment intent ID:",o);const r=this.paymentDataCache.get(o);console.log("Cached payment data:",r);const h={id:o,status:"succeeded",amount:r?Math.round(r.amount*100):100,currency:"usd",metadata:{studentName:(r==null?void 0:r.studentName)||"Test User",studentEmail:(r==null?void 0:r.studentEmail)||"test@example.com",studentPhone:(r==null?void 0:r.studentPhone)||"",classDetails:JSON.stringify((r==null?void 0:r.classDetails)||{}),packageDetails:JSON.stringify((r==null?void 0:r.packageDetails)||{})}};console.log("Mock payment intent created:",h),console.log("Payment processing complete, calling onSuccess..."),t(h),console.log("âœ… onSuccess callback called")}catch(n){console.error("âŒ Payment processing error:",n),console.error("âŒ Error stack:",n.stack),a(n.message||"Payment processing failed")}}static async handleSuccessfulPayment(s){try{const t=s.metadata,a=JSON.parse(t.classDetails||"{}"),n=JSON.parse(t.packageDetails||"{}");a.className?(await _.createBooking({student_name:t.studentName,student_email:t.studentEmail,class_name:a.className,teacher:a.teacher,class_date:a.day,class_time:a.time,payment_method:"Credit Card",amount:t.amount/100,zoom_meeting_id:a.zoomMeetingId,zoom_password:a.zoomPassword,zoom_link:a.zoomLink}),await j.sendBookingNotification({studentName:t.studentName,studentEmail:t.studentEmail,className:a.className,teacher:a.teacher,date:a.day,time:a.time,zoomMeetingId:a.zoomMeetingId,zoomPassword:a.zoomPassword,zoomLink:a.zoomLink}),await j.sendStudentConfirmation({studentName:t.studentName,studentEmail:t.studentEmail,className:a.className,teacher:a.teacher,date:a.day,time:a.time,zoomMeetingId:a.zoomMeetingId,zoomPassword:a.zoomPassword,zoomLink:a.zoomLink})):n.type&&(await _.createPackage({student_email:t.studentEmail,package_type:n.type,total_classes:n.type==="five"?5:10,remaining_classes:n.type==="five"?5:10}),await j.sendPackagePurchaseNotification({studentName:t.studentName,studentEmail:t.studentEmail,packageType:n.type,packagePrice:t.amount/100,classesAdded:n.type==="five"?5:10,totalClasses:n.type==="five"?5:10}),await j.sendPackagePurchaseConfirmation({studentName:t.studentName,studentEmail:t.studentEmail,packageType:n.type,packagePrice:t.amount/100,classesAdded:n.type==="five"?5:10,totalClasses:n.type==="five"?5:10}))}catch(t){console.error("Error handling successful payment:",t)}}static async validatePayment(s){try{const t=await fetch(`/api/validate-payment/${s}`),{status:a}=await t.json();return a==="succeeded"}catch(t){return console.error("Error validating payment:",t),!1}}}b(P,"stripe",null),b(P,"paymentDataCache",new Map);function se({onBack:i,selectedClass:s,selectedPackage:t,onSuccess:a,user:n}){const[o,r]=g.useState({name:(n==null?void 0:n.name)||"",email:(n==null?void 0:n.email)||"",phone:""});g.useEffect(()=>{n&&r({name:n.name||"",email:n.email||"",phone:""})},[n]);const[h,C]=g.useState(!1),[L,f]=g.useState(null),D=async()=>{if(!(!o.name||!o.email)){C(!0),f(null);try{const l={studentName:o.name,studentEmail:o.email,studentPhone:o.phone,amount:s?11:t?t.price:0,classDetails:s,packageDetails:t};console.log("Creating payment intent with data:",l);const c=await P.createPaymentIntent(l);if(!c)throw new Error("Failed to create payment intent");console.log("Payment intent created, client secret:",c),console.log("Processing payment...");try{await P.processPayment(c,d=>{console.log("Payment succeeded:",d),a()},d=>{console.error("Payment failed:",d),f(d)}),console.log("Payment processing completed")}catch(d){console.error("Error in payment processing:",d),f("Payment processing failed: "+((d==null?void 0:d.message)||"Unknown error"))}}catch(l){f(l.message||"Payment failed. Please try again.")}finally{C(!1)}}};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[e.jsxs(I,{variant:"outline",size:"sm",onClick:i,className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-heading",children:"Secure Payment"})]}),e.jsxs(y,{className:"mb-6",children:[e.jsx(v,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"Payment Method"]})}),e.jsx(S,{children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(J,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-800",children:"Secure Payment with Stripe"})]}),e.jsx("p",{className:"text-green-700 text-sm",children:"Your payment is processed securely by Stripe. We accept all major credit cards, debit cards, and digital wallets."}),e.jsxs("div",{className:"flex items-center gap-4 mt-3 text-xs text-green-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(O,{className:"w-3 h-3"}),e.jsx("span",{children:"Bank-level security"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"w-3 h-3"}),e.jsx("span",{children:"PCI compliant"})]})]})]})})]}),e.jsxs(y,{className:"mb-6",children:[e.jsx(v,{children:e.jsx(N,{children:"Order Summary"})}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:s?"Single Class":t==null?void 0:t.name}),e.jsxs("span",{className:"font-bold",children:["$",s?"11.00":t?t.price.toFixed(2):"0.00"]})]}),s&&e.jsxs("div",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Class:"})," ",s.className]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Teacher:"})," ",s.teacher]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",s.day]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," ",s.time]})]}),t&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Package Type:"})," ",t.type==="five"?"5-Class Package":"10-Class Package"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Classes Included:"})," ",t.type==="five"?"5":"10"]})]}),e.jsxs("div",{className:"border-t pt-3 mt-3",children:[e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",s?"11.00":t?t.price.toFixed(2):"0.00"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"* Processing fees included in total"})]})]})})]}),e.jsxs(y,{className:"mb-6",children:[e.jsx(v,{children:e.jsx(N,{children:"Student Information"})}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"studentName",children:"Full Name *"}),e.jsx(u,{id:"studentName",value:o.name,onChange:l=>r(c=>({...c,name:l.target.value})),placeholder:"Enter your full name",required:!0})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"studentEmail",children:"Email Address *"}),e.jsx(u,{id:"studentEmail",type:"email",value:o.email,onChange:l=>r(c=>({...c,email:l.target.value})),placeholder:"Enter your email address",required:!0})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"studentPhone",children:"Phone Number"}),e.jsx(u,{id:"studentPhone",value:o.phone,onChange:l=>r(c=>({...c,phone:l.target.value})),placeholder:"Enter your phone number"})]})]})})]}),e.jsxs(y,{className:"mb-6",children:[e.jsx(v,{children:e.jsx(N,{children:"Payment Information"})}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"cardNumber",children:"Card Number *"}),e.jsx(u,{id:"cardNumber",placeholder:"1234 5678 9012 3456",className:"font-mono"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"We accept Visa, Mastercard, Discover, and American Express"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"expiryDate",children:"Expiry Date *"}),e.jsx(u,{id:"expiryDate",placeholder:"MM/YY",className:"font-mono"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"cvv",children:"CVV *"}),e.jsx(u,{id:"cvv",placeholder:"123",className:"font-mono",maxLength:4})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"billingZip",children:"Billing ZIP Code *"}),e.jsx(u,{id:"billingZip",placeholder:"12345",className:"font-mono",maxLength:10})]})]})})]}),L&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-red-700 text-sm",children:L})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(I,{onClick:i,variant:"outline",className:"flex-1",children:"Cancel"}),e.jsx(I,{onClick:D,disabled:h||!o.name||!o.email,className:"flex-1",children:h?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-4 h-4 mr-2 animate-spin"}),"Processing..."]}):`Pay $${s?"11.00":t?t.price.toFixed(2):"0.00"}`})]})]})})})}export{se as StripePaymentPage};
